<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Sigma Study House</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/auth.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container header-container">
            <div class="logo">
                <a href="../index.html" style="text-decoration: none; display: flex; align-items: center;">
                    <div class="logo-placeholder">Î£</div>
                    <div class="logo-text">Sigma<span>StudyHouse</span></div>
                </a>
            </div>
            <nav>
                <ul>
                    <li><a href="../index.html">Home</a></li>
                    <li><a href="about.html">About</a></li>
                    <li class="dropdown">
                        <a href="services.html">Services <i class="fas fa-chevron-down"></i></a>
                        <div class="dropdown-content">
                            <a href="courses.html">Courses</a>
                            <a href="booking.html">Booking</a>
                            <a href="printing.html">Printing</a>
                        </div>
                    </li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </nav>
            <div class="header-controls">
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon"></i>
                </button>
                <div class="auth-buttons" id="authButtons">
                    <!-- This will be populated by JavaScript based on auth state -->
                </div>
            </div>
        </div>
    </header>

    <!-- Profile Page Content -->
    <section class="profile">
        <div class="container">
            <h1 class="section-title">My Profile</h1>
            <div class="profile-container">
                <div class="profile-sidebar">
                    <div class="profile-avatar" id="profileAvatar">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    <h3 id="userName" style="text-align: center;">User Name</h3>
                    <p id="userEmail" style="text-align: center; color: var(--text-light);">user@email.com</p>
                    
                    <ul class="profile-nav">
                        <li><a href="#" data-section="personal-info" class="active">Personal Information</a></li>
                        <li><a href="#" data-section="bookings">Booking History</a></li>
                        <li><a href="#" data-section="printing-orders">Printing Orders</a></li>
                        <li><a href="#" data-section="credit">Credit & Payments</a></li>
                        <li><a href="#" data-section="settings">Account Settings</a></li>
                    </ul>
                </div>
                
                <div class="profile-main">
                    <!-- Personal Information Section -->
                    <div id="personal-info" class="profile-section active">
                        <h2>Personal Information</h2>
                        <div class="credit-balance">
                            <h3>Account Balance</h3>
                            <div class="credit-amount" id="currentBalance">25.00 JOD</div>
                            <p>Available credit for bookings and services</p>
                        </div>
                        
                        <form id="personalInfoForm">
                            <div class="form-group">
                                <label for="fullName">Full Name</label>
                                <input type="text" class="form-control" id="fullName" value="John Doe">
                            </div>
                            <div class="form-group">
                                <label for="profileEmail">Email Address</label>
                                <input type="email" class="form-control" id="profileEmail" value="john.doe@example.com" readonly>
                            </div>
                            <div class="form-group">
                                <label for="phone">Phone Number</label>
                                <input type="tel" class="form-control" id="phone" value="+962 79 610 1060">
                            </div>
                            <div class="form-group">
                                <label for="studentId">Student ID (Optional)</label>
                                <input type="text" class="form-control" id="studentId" placeholder="Enter your student ID for discounts">
                            </div>
                            <div class="form-group">
                                <label for="preferences">Study Preferences</label>
                                <select class="form-control" id="preferences" multiple>
                                    <option value="silent" selected>Silent Rooms</option>
                                    <option value="solo">Solo Rooms</option>
                                    <option value="group">Group Study</option>
                                    <option value="coffee">Coffee Point Access</option>
                                </select>
                                <small style="color: var(--text-light);">Hold Ctrl to select multiple options</small>
                            </div>
                            <button type="submit" class="btn btn-primary">Update Information</button>
                        </form>
                    </div>
                    
                    <!-- Booking History Section -->
                    <div id="bookings" class="profile-section">
                        <h2>Booking History</h2>
                        <div class="booking-history">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Room Type</th>
                                        <th>Time</th>
                                        <th>Duration</th>
                                        <th>Cost</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="bookingsTableBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Printing Orders Section -->
                    <div id="printing-orders" class="profile-section">
                        <h2>Printing Orders</h2>
                        <div class="booking-history">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Order Date</th>
                                        <th>Files</th>
                                        <th>Pages</th>
                                        <th>Cost</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="printingTableBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Credit & Payments Section -->
                    <div id="credit" class="profile-section">
                        <h2>Credit & Payments</h2>
                        <div class="credit-balance">
                            <h3>Current Balance</h3>
                            <div class="credit-amount" id="creditBalance">25.00 JOD</div>
                            <p>Available credit for all services</p>
                        </div>
                        
                        <div class="form-group">
                            <label for="creditAmount">Add Credit Amount (JOD)</label>
                            <input type="number" class="form-control" id="creditAmount" min="5" max="500" step="5" value="25">
                            <small style="color: var(--text-light);">Minimum amount: 5 JOD</small>
                        </div>
                        <button class="btn btn-primary" id="addCreditBtn">Add Credit</button>
                        
                        <div style="margin-top: 30px;">
                            <h3>Payment History</h3>
                            <div class="booking-history">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Description</th>
                                            <th>Amount</th>
                                            <th>Type</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paymentHistoryBody">
                                        <!-- Will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Account Settings Section -->
                    <div id="settings" class="profile-section">
                        <h2>Account Settings</h2>
                        
                        <div class="form-group">
                            <label>Notification Preferences</label>
                            <div style="margin: 10px 0;">
                                <label style="display: block; margin: 5px 0;">
                                    <input type="checkbox" checked> Email notifications
                                </label>
                                <label style="display: block; margin: 5px 0;">
                                    <input type="checkbox" checked> SMS notifications
                                </label>
                                <label style="display: block; margin: 5px 0;">
                                    <input type="checkbox"> promotional offers
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="language">Language Preference</label>
                            <select class="form-control" id="language">
                                <option value="en">English</option>
                                <option value="ar">Arabic</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="timezone">Timezone</label>
                            <select class="form-control" id="timezone">
                                <option value="+3">Amman, Jordan (UTC+3)</option>
                                <option value="+0">London (UTC+0)</option>
                                <option value="-5">New York (UTC-5)</option>
                            </select>
                        </div>
                        
                        <div style="margin: 30px 0; padding: 20px; background-color: var(--light); border-radius: 5px;">
                            <h3 style="color: var(--accent);">Danger Zone</h3>
                            <p>Once you delete your account, there is no going back. Please be certain.</p>
                            <button class="btn btn-outline" style="border-color: var(--accent); color: var(--accent);">Delete Account</button>
                        </div>
                        
                        <button class="btn btn-primary">Save Settings</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-container">
                <div class="footer-about">
                    <div class="footer-logo">Sigma<span>StudyHouse</span></div>
                    <p>Providing comfortable, well-equipped spaces for studying, teamwork, and discussions in Amman, Jordan.</p>
                    <div class="social-links">
                        <a href="#" class="social-link"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-whatsapp"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-tiktok"></i></a>
                    </div>
                </div>
                <div class="footer-links">
                    <h4 class="footer-heading">Quick Links</h4>
                    <ul>
                        <li><a href="../index.html">Home</a></li>
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="services.html">Services</a></li>
                        <li><a href="courses.html">Courses</a></li>
                        <li><a href="booking.html">Booking</a></li>
                    </ul>
                </div>
                <div class="footer-links">
                    <h4 class="footer-heading">Services</h4>
                    <ul>
                        <li><a href="services.html">Silent Rooms</a></li>
                        <li><a href="services.html">Solo Rooms</a></li>
                        <li><a href="services.html">Meeting Rooms</a></li>
                        <li><a href="printing.html">Printing Services</a></li>
                        <li><a href="services.html">Coffee Point</a></li>
                    </ul>
                </div>
                <div class="footer-links">
                    <h4 class="footer-heading">Contact Info</h4>
                    <ul>
                        <li><a href="contact.html">Wasfi Al-Tal Street, Amman</a></li>
                        <li><a href="mailto:info@sigmastudyhouse.com">info@sigmastudyhouse.com</a></li>
                        <li><a href="tel:00962796101060">00962796101060</a></li>
                        <li><a href="contact.html">Open 24/7</a></li>
                    </ul>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2023 Sigma Study House. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Sign In to Your Account</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="auth-options">
                    <div class="auth-option" id="googleSignIn">
                        <div class="auth-icon">
                            <i class="fab fa-google"></i>
                        </div>
                        <div>
                            <h4>Continue with Google</h4>
                            <p>Sign in with your Google account</p>
                        </div>
                    </div>
                    <div class="auth-option">
                        <div class="auth-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div>
                            <h4>Sign in with Email</h4>
                            <p>Use your email address</p>
                        </div>
                    </div>
                </div>
                <p style="text-align: center; margin-top: 20px;">Don't have an account? <a href="#" style="color: var(--primary);">Sign up here</a></p>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <!-- App Scripts -->
    <script src="../js/firebase-config.js"></script>
    <script src="../js/database.js"></script>
    <script src="../js/main.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // Profile page specific functionality
        document.addEventListener('DOMContentLoaded', async function() {
            // Wait for auth to load
            let attempts = 0;
            while (!window.authManager && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }

            if (!window.authManager || !window.authManager.currentUser) {
                alert('Please sign in to view your profile');
                window.location.href = '../index.html';
                return;
            }

            const currentUser = window.authManager.currentUser;

            // Update profile header
            const userName = document.getElementById('userName');
            const userEmail = document.getElementById('userEmail');

            if (userName) userName.textContent = currentUser.name || 'User';
            if (userEmail) userEmail.textContent = currentUser.email;

            // Populate form fields
            const fullNameInput = document.getElementById('fullName');
            const profileEmailInput = document.getElementById('profileEmail');
            const phoneInput = document.getElementById('phone');
            const studentIdInput = document.getElementById('studentId');

            if (fullNameInput) fullNameInput.value = currentUser.name || '';
            if (profileEmailInput) profileEmailInput.value = currentUser.email || '';
            if (phoneInput) phoneInput.value = currentUser.phone || '';
            if (studentIdInput) studentIdInput.value = currentUser.studentId || '';

            // Update credit displays
            updateCreditDisplay();

            // Load data
            await loadBookingHistory();
            await loadPrintingOrders();
            await loadPaymentHistory();

            // Set up profile navigation
            setupProfileNavigation();
            
            // Personal info form
            document.getElementById('personalInfoForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const currentUser = window.authManager.currentUser;

                try {
                    const updates = {
                        name: document.getElementById('fullName').value,
                        phone: document.getElementById('phone').value,
                        studentId: document.getElementById('studentId').value
                    };

                    await window.db.update('users', currentUser.id, updates);
                    window.authManager.currentUser = { ...currentUser, ...updates };

                    if (window.authManager.showNotification) {
                        window.authManager.showNotification('Personal information updated successfully!', 'success');
                    } else {
                        alert('Personal information updated successfully!');
                    }
                } catch (error) {
                    console.error('Error updating profile:', error);
                    if (window.authManager.showNotification) {
                        window.authManager.showNotification('Failed to update profile', 'error');
                    } else {
                        alert('Failed to update profile');
                    }
                }
            });

            // Add credit functionality
            document.getElementById('addCreditBtn').addEventListener('click', async function() {
                const currentUser = window.authManager.currentUser;
                const amount = parseFloat(document.getElementById('creditAmount').value) || 0;

                if (amount >= 5) {
                    try {
                        const newCredit = (currentUser.credit || 25.00) + amount;

                        // Update user credit in Firebase
                        await window.db.update('users', currentUser.id, { credit: newCredit });

                        // Add to payment history
                        await window.db.create('paymentHistory', {
                            userId: currentUser.id,
                            date: new Date().toISOString(),
                            description: 'Credit Top-up',
                            amount: amount,
                            type: 'credit'
                        });

                        // Update local user object
                        window.authManager.currentUser.credit = newCredit;
                        window.authManager.userCredit = newCredit;

                        updateCreditDisplay();
                        await loadPaymentHistory();

                        if (window.authManager.showNotification) {
                            window.authManager.showNotification(`Successfully added ${amount.toFixed(2)} JOD to your account!`, 'success');
                        } else {
                            alert(`Successfully added ${amount.toFixed(2)} JOD to your account!`);
                        }
                    } catch (error) {
                        console.error('Error adding credit:', error);
                        if (window.authManager.showNotification) {
                            window.authManager.showNotification('Failed to add credit', 'error');
                        } else {
                            alert('Failed to add credit');
                        }
                    }
                } else {
                    if (window.authManager.showNotification) {
                        window.authManager.showNotification('Minimum credit amount is 5 JOD', 'error');
                    } else {
                        alert('Minimum credit amount is 5 JOD');
                    }
                }
            });
        });

        function updateCreditDisplay() {
            const currentUser = window.authManager?.currentUser;
            if (!currentUser) return;

            const credit = currentUser.credit || 25.00;
            const balanceElements = document.querySelectorAll('#currentBalance, #creditBalance');

            balanceElements.forEach(el => {
                if (el) el.textContent = `${credit.toFixed(2)} JOD`;
            });
        }

        function setupProfileNavigation() {
            const navLinks = document.querySelectorAll('.profile-nav a');
            const sections = document.querySelectorAll('.profile-section');

            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();

                    const targetSection = this.getAttribute('data-section');

                    // Remove active class from all links and sections
                    navLinks.forEach(l => l.classList.remove('active'));
                    sections.forEach(s => s.classList.remove('active'));

                    // Add active class to clicked link and target section
                    this.classList.add('active');
                    const section = document.getElementById(targetSection);
                    if (section) section.classList.add('active');
                });
            });
        }

        async function loadBookingHistory() {
            const currentUser = window.authManager?.currentUser;
            if (!currentUser) return;

            const tbody = document.getElementById('bookingsTableBody');

            try {
                const bookings = await window.db.query('bookings', [
                    ['userId', '==', currentUser.id]
                ]);

                if (bookings.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">No bookings found</td></tr>';
                    return;
                }

                // Sort by date (newest first)
                bookings.sort((a, b) => new Date(b.date || b.createdAt) - new Date(a.date || a.createdAt));

                tbody.innerHTML = bookings.map(booking => {
                    const date = new Date(booking.date || booking.createdAt);
                    return `
                        <tr>
                            <td>${date.toLocaleDateString('en-JO')}</td>
                            <td>${formatRoomType(booking.roomType || booking.roomId)}</td>
                            <td>${booking.startTime || 'N/A'} - ${booking.endTime || 'N/A'}</td>
                            <td>${(booking.duration || 2).toFixed(1)} hours</td>
                            <td>${(booking.totalCost || 0).toFixed(2)} JOD</td>
                            <td><span class="status-${booking.status || 'confirmed'}">${booking.status || 'confirmed'}</span></td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading bookings:', error);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Error loading bookings</td></tr>';
            }
        }

        async function loadPrintingOrders() {
            const currentUser = window.authManager?.currentUser;
            if (!currentUser) return;

            const tbody = document.getElementById('printingTableBody');

            try {
                const orders = await window.db.query('printingOrders', [
                    ['userId', '==', currentUser.id]
                ]);

                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No printing orders found</td></tr>';
                    return;
                }

                tbody.innerHTML = orders.map(order => `
                    <tr>
                        <td>${new Date(order.createdAt).toLocaleDateString('en-JO')}</td>
                        <td>${(order.files?.length || 0)} file(s)</td>
                        <td>${order.totalPages || 0}</td>
                        <td>${(order.cost || 0).toFixed(2)} JOD</td>
                        <td><span class="status-${order.status || 'pending'}">${order.status || 'pending'}</span></td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading printing orders:', error);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">Error loading printing orders</td></tr>';
            }
        }

        async function loadPaymentHistory() {
            const currentUser = window.authManager?.currentUser;
            if (!currentUser) return;

            const tbody = document.getElementById('paymentHistoryBody');

            try {
                let payments = await window.db.query('paymentHistory', [
                    ['userId', '==', currentUser.id]
                ]);

                // Sort by date (newest first)
                payments.sort((a, b) => new Date(b.date) - new Date(a.date));

                if (payments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">No payment history found</td></tr>';
                    return;
                }

                tbody.innerHTML = payments.map(payment => `
                    <tr>
                        <td>${new Date(payment.date).toLocaleDateString('en-JO')}</td>
                        <td>${payment.description}</td>
                        <td style="color: ${payment.type === 'credit' ? 'var(--success)' : 'var(--accent)'}">
                            ${payment.type === 'credit' ? '+' : ''}${payment.amount.toFixed(2)} JOD
                        </td>
                        <td><span class="status-${payment.type}">${payment.type}</span></td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading payment history:', error);
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">Error loading payment history</td></tr>';
            }
        }

        function formatRoomType(roomType) {
            const types = {
                'silent': 'Silent Room',
                'solo': 'Solo Room',
                'meeting-small': 'Small Meeting Room',
                'meeting-medium': 'Medium Meeting Room',
                'meeting-large': 'Large Meeting Room'
            };
            return types[roomType] || roomType;
        }
    </script>
</body>
</html>